name: XWP Automation - Change-Driven Testing

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      execution_mode:
        description: 'Test execution mode'
        required: true
        default: 'change-driven'
        type: choice
        options:
          - 'change-driven'
          - 'run-all'
          - 'run-specific'
      specific_tests:
        description: 'Specific tests/folders to run (only used with "run-specific" mode) - excludes login tests'
        required: false
        default: 'tests/dashboard.spec.ts'
        type: string
      browser_matrix:
        description: 'Browser coverage'
        required: false
        default: 'chromium-only'
        type: choice
        options:
          - 'chromium-only'
          - 'cross-browser'
      target_branch:
        description: 'Target branch to test (for E2E mode)'
        required: false
        default: 'main'
        type: string
      include_login_test:
        description: 'Include authentication setup test'
        required: false
        default: false
        type: boolean

jobs:
  detect-changes:
    name: üîç Analyze Changes & Plan Tests
    runs-on: ubuntu-latest
    outputs:
      changed-files: ${{ steps.changes.outputs.files }}
      test-strategy: ${{ steps.strategy.outputs.strategy }}
      tests-to-run: ${{ steps.strategy.outputs.tests }}
      skip-tests: ${{ steps.strategy.outputs.skip }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changes
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }})
          else
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
          fi
          
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: üß† Determine Test Strategy
        id: strategy
        run: |
          CHANGED_FILES="${{ steps.changes.outputs.files }}"
          TESTS_TO_RUN=""
          STRATEGY="targeted"
          SKIP_TESTS="false"
          EXECUTION_MODE="${{ github.event.inputs.execution_mode || 'change-driven' }}"
          
          echo "üìÅ Changed files:"
          echo "$CHANGED_FILES"
          echo "üéØ Execution mode: $EXECUTION_MODE"
          echo ""
          
          # Handle manual workflow dispatch modes
          if [ "$EXECUTION_MODE" = "run-all" ]; then
            echo "üöÄ Manual: Run all tests requested"
            TESTS_TO_RUN="all"
            STRATEGY="manual-full"
          elif [ "$EXECUTION_MODE" = "run-specific" ]; then
            SPECIFIC_TESTS="${{ github.event.inputs.specific_tests }}"
            echo "üéØ Manual: Run specific tests - $SPECIFIC_TESTS"
            
            # Filter out login tests - they should only run via authentication setup
            FILTERED_TESTS=$(echo "$SPECIFIC_TESTS" | sed 's/tests-excluded\/login\.spec\.ts//g' | sed 's/login\.spec\.ts//g' | sed 's/  */ /g' | sed 's/^ *//g' | sed 's/ *$//g')
            
            if [ "$FILTERED_TESTS" != "$SPECIFIC_TESTS" ]; then
              echo "üö´ Login tests removed from manual execution - use 'include_login_test' option instead"
            fi
            
            if [ -z "$FILTERED_TESTS" ] || [ "$FILTERED_TESTS" = " " ]; then
              echo "‚ö†Ô∏è No valid tests specified after filtering - defaulting to dashboard test"
              TESTS_TO_RUN="tests/dashboard.spec.ts"
            else
              TESTS_TO_RUN="$FILTERED_TESTS"
            fi
            STRATEGY="manual-specific"
          elif [ "$EXECUTION_MODE" = "change-driven" ]; then
            # Original change-driven logic
            
            # Skip if only documentation changes
            if echo "$CHANGED_FILES" | grep -qE '\.(md|txt|json)$' && ! echo "$CHANGED_FILES" | grep -qvE '\.(md|txt|json)$'; then
              echo "üìù Only documentation changes detected - skipping tests"
              SKIP_TESTS="true"
              STRATEGY="skip"
            else
              echo "üîç Analyzing changed files for test impact..."
              
              # Check for page object changes
              if echo "$CHANGED_FILES" | grep -q "pages/.*\.ts"; then
                CHANGED_PAGES=$(echo "$CHANGED_FILES" | grep "pages/.*\.ts" | sed 's/pages\///g' | sed 's/\.ts//g')
                echo "üìÑ Page objects changed: $CHANGED_PAGES"
                
                for page in $CHANGED_PAGES; do
                  case $page in
                    "login.page"|"base.page")
                      echo "üîê Login page changes detected - authentication setup will be triggered"
                      ;;
                    "dashboard.page")
                      TESTS_TO_RUN="$TESTS_TO_RUN tests/dashboard.spec.ts"
                      ;;
                    "categories.page")
                      TESTS_TO_RUN="$TESTS_TO_RUN tests/categories.spec.ts"
                      ;;
                    "all-posts.page")
                      TESTS_TO_RUN="$TESTS_TO_RUN tests/all-posts.spec.ts"
                      ;;
                    "post.page")
                      TESTS_TO_RUN="$TESTS_TO_RUN tests/post-creation.spec.ts"
                      ;;
                    "page.factory")
                      TESTS_TO_RUN="$TESTS_TO_RUN tests/dashboard.spec.ts tests/categories.spec.ts"
                      ;;
                  esac
                done
              fi
              
              # Check for utility changes
              if echo "$CHANGED_FILES" | grep -q "utils/.*\.ts"; then
                CHANGED_UTILS=$(echo "$CHANGED_FILES" | grep "utils/.*\.ts")
                echo "üîß Utilities changed: $CHANGED_UTILS"
                
                if echo "$CHANGED_UTILS" | grep -q "element.helper\|test.utils\|environment.utils"; then
                  echo "üö® Core utilities changed - running all tests"
                  TESTS_TO_RUN="all"
                  STRATEGY="full"
                elif echo "$CHANGED_UTILS" | grep -q "smart-logger\|error-inspector\|ai-test-healer"; then
                  echo "üß† AI/Logging utilities changed - running smoke tests"
                  TESTS_TO_RUN="tests/dashboard.spec.ts"
                  STRATEGY="smoke"
                fi
              fi
              
              # Check for fixture/data changes
              if echo "$CHANGED_FILES" | grep -q "fixtures/.*\.ts"; then
                echo "üìä Test data changed - running related tests"
                if echo "$CHANGED_FILES" | grep -q "login-data"; then
                  echo "üîê Login data changes detected - authentication setup will be triggered"
                fi
                if echo "$CHANGED_FILES" | grep -q "dashboard-data"; then
                  TESTS_TO_RUN="$TESTS_TO_RUN tests/dashboard.spec.ts"
                fi
              fi
              
              # Check for configuration changes
              if echo "$CHANGED_FILES" | grep -qE "(playwright\.config|tsconfig|package\.json|\.env)"; then
                echo "‚öôÔ∏è Configuration changed - running smoke tests"
                TESTS_TO_RUN="tests/dashboard.spec.ts"
                STRATEGY="config"
              fi
              
              # Check for test file changes
              if echo "$CHANGED_FILES" | grep -q "tests/.*\.spec\.ts"; then
                CHANGED_TESTS=$(echo "$CHANGED_FILES" | grep "tests/.*\.spec\.ts")
                echo "üß™ Test files changed: $CHANGED_TESTS"
                TESTS_TO_RUN="$TESTS_TO_RUN $CHANGED_TESTS"
              fi
              
              # If no specific tests identified, run smoke tests
              if [ -z "$TESTS_TO_RUN" ] && [ "$SKIP_TESTS" = "false" ]; then
                echo "üîç No specific test mapping found - running smoke tests"
                TESTS_TO_RUN="tests/dashboard.spec.ts"
                STRATEGY="smoke"
              fi
            fi
          fi
          
          # Clean up test list
          TESTS_TO_RUN=$(echo "$TESTS_TO_RUN" | tr ' ' '\n' | sort -u | tr '\n' ' ' | sed 's/[[:space:]]*$//')
          
          echo "üéØ Test Strategy: $STRATEGY"
          echo "üß™ Tests to run: $TESTS_TO_RUN"
          echo "‚è≠Ô∏è Skip tests: $SKIP_TESTS"
          
          echo "strategy=$STRATEGY" >> $GITHUB_OUTPUT
          echo "tests=$TESTS_TO_RUN" >> $GITHUB_OUTPUT
          echo "skip=$SKIP_TESTS" >> $GITHUB_OUTPUT

  run-tests-with-auth:
    name: üß™ Execute Tests (with Auth Setup)
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.skip-tests != 'true'
    strategy:
      matrix:
        browser: ${{ github.event.inputs.browser_matrix == 'cross-browser' && fromJSON('["chromium", "firefox", "webkit"]') || fromJSON('["chromium"]') }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.target_branch || github.ref }}
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Setup dependencies
        run: |
          npm ci
          npx playwright install ${{ matrix.browser }} --with-deps

      - name: üîê Run authentication setup (always)
        run: |
          # Create temporary config for login test
          cat > playwright.config.temp.ts << 'EOF'
          import { defineConfig, devices } from '@playwright/test';
          import { config } from 'dotenv';
          config();
          export default defineConfig({
            testDir: './tests-excluded',
            fullyParallel: true,
            forbidOnly: !!process.env.CI,
            retries: process.env.CI ? 2 : 0,
            workers: 1,
            reporter: 'html',
            use: {
              baseURL: process.env.STAGING_BASE_URL || 'https://staging.go.ione.nyc',
              trace: 'on-first-retry',
              screenshot: 'only-on-failure',
            },
            projects: [{ name: 'chromium', use: { ...devices['Desktop Chrome'] } }],
          });
          EOF
          
          cat > .env << 'EOF'
          STAGING_BASE_URL=${{ secrets.STAGING_BASE_URL || 'https://staging.go.ione.nyc' }}
          STAGING_API_URL=${{ secrets.STAGING_API_URL || 'https://staging.go.ione.nyc/wp-json' }}
          STAGING_LOGIN_URL=${{ secrets.STAGING_BASE_URL || 'https://staging.go.ione.nyc' }}/wp-login.php?skip_sso
          ADMIN_USERNAME=${{ secrets.ADMIN_USERNAME }}
          ADMIN_PASSWORD=${{ secrets.ADMIN_PASSWORD }}
          EOF
          
          # Run login test to create authentication state
          echo "üîê Running authentication setup..."
          npx playwright test login.spec.ts --config=playwright.config.temp.ts --project=chromium
          rm -f playwright.config.temp.ts .env
          
          # Ensure the .auth directory exists and check file creation
          mkdir -p playwright/.auth
          if [ -f "playwright/.auth/staging-ione.json" ]; then
            echo "‚úÖ Authentication state created successfully"
            ls -la playwright/.auth/
          else
            echo "‚ùå Authentication state not created"
            echo "üìÅ Checking playwright directory structure:"
            find . -name "*.json" -path "*/.auth/*" 2>/dev/null || echo "No auth files found"
          fi

      - name: üéØ Run targeted tests
        run: |
          # Debug: Show current directory and file structure
          echo "üìÅ Current working directory: $(pwd)"
          echo "üîç Looking for authentication state file..."
          echo "üìÇ Directory structure:"
          ls -la playwright/ 2>/dev/null || echo "‚ùå No playwright directory found"
          ls -la playwright/.auth/ 2>/dev/null || echo "‚ùå No .auth directory found"
          
          # Check if authentication state is available
          AUTH_STATE=""
          AUTH_FILE_PATH="playwright/.auth/staging-ione.json"
          if [ -f "$AUTH_FILE_PATH" ]; then
            AUTH_STATE="storageState: '$AUTH_FILE_PATH',"
            echo "‚úÖ Using authentication state for tests: $AUTH_FILE_PATH"
            echo "üìÑ File size: $(stat -c%s "$AUTH_FILE_PATH" 2>/dev/null || stat -f%z "$AUTH_FILE_PATH" 2>/dev/null || echo "unknown") bytes"
          else
            echo "‚è≠Ô∏è Running tests without authentication state"
            echo "‚ùå File not found: $AUTH_FILE_PATH"
          fi
          
          # Create config for main tests
          cat > playwright.config.temp.ts << EOF
          import { defineConfig, devices } from '@playwright/test';
          import { config } from 'dotenv';
          config();
          export default defineConfig({
            testDir: './tests',
            fullyParallel: true,
            forbidOnly: !!process.env.CI,
            retries: process.env.CI ? 2 : 0,
            workers: 1,
            reporter: 'html',
            use: {
              baseURL: process.env.STAGING_BASE_URL || 'https://staging.go.ione.nyc',
              trace: 'on-first-retry',
              screenshot: 'only-on-failure',
              ${AUTH_STATE}
            },
            projects: [{ name: '${{ matrix.browser }}', use: { ...devices['Desktop Chrome'] } }],
          });
          EOF
          
          cat > .env << 'EOF'
          STAGING_BASE_URL=${{ secrets.STAGING_BASE_URL || 'https://staging.go.ione.nyc' }}
          STAGING_API_URL=${{ secrets.STAGING_API_URL || 'https://staging.go.ione.nyc/wp-json' }}
          STAGING_LOGIN_URL=${{ secrets.STAGING_BASE_URL || 'https://staging.go.ione.nyc' }}/wp-login.php?skip_sso
          ADMIN_USERNAME=${{ secrets.ADMIN_USERNAME }}
          ADMIN_PASSWORD=${{ secrets.ADMIN_PASSWORD }}
          EOF
          
          # Run tests
          TESTS="${{ needs.detect-changes.outputs.tests-to-run }}"
          if [ "$TESTS" = "all" ]; then
            echo "üöÄ Running full test suite"
            npx playwright test --config=playwright.config.temp.ts --project=${{ matrix.browser }}
          else
            echo "üéØ Running targeted tests: $TESTS"
            npx playwright test $TESTS --config=playwright.config.temp.ts --project=${{ matrix.browser }}
          fi
          
          # Cleanup all temporary files
          rm -f playwright.config.temp.ts .env
          rm -f playwright/.auth/staging-ione.json

      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.browser }}
          path: |
            test-results/
            playwright-report/
          retention-days: 3