name: XWP Automation - Change-Driven Testing

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      execution_mode:
        description: 'Test execution mode'
        required: true
        default: 'change-driven'
        type: choice
        options:
          - 'change-driven'
          - 'run-all'
          - 'run-specific'
      specific_tests:
        description: 'Specific tests/folders to run (only used with "run-specific" mode) - excludes login tests'
        required: false
        default: 'tests/dashboard.spec.ts'
        type: string
      browser_matrix:
        description: 'Browser coverage'
        required: false
        default: 'chromium-only'
        type: choice
        options:
          - 'chromium-only'
          - 'cross-browser'
      target_branch:
        description: 'Target branch to test (for E2E mode)'
        required: false
        default: 'main'
        type: string
      include_login_test:
        description: 'Include authentication setup test'
        required: false
        default: false
        type: boolean

jobs:
  detect-changes:
    name: üîç Analyze Changes & Plan Tests
    runs-on: ubuntu-latest
    outputs:
      changed-files: ${{ steps.changes.outputs.files }}
      test-strategy: ${{ steps.strategy.outputs.strategy }}
      tests-to-run: ${{ steps.strategy.outputs.tests }}
      skip-tests: ${{ steps.strategy.outputs.skip }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changes
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }})
          else
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
          fi
          
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: üß† Determine Test Strategy
        id: strategy
        run: |
          CHANGED_FILES="${{ steps.changes.outputs.files }}"
          TESTS_TO_RUN=""
          STRATEGY="targeted"
          SKIP_TESTS="false"
          EXECUTION_MODE="${{ github.event.inputs.execution_mode || 'change-driven' }}"
          
          echo "üìÅ Changed files:"
          echo "$CHANGED_FILES"
          echo "üéØ Execution mode: $EXECUTION_MODE"
          echo ""
          
          # Handle manual workflow dispatch modes
          if [ "$EXECUTION_MODE" = "run-all" ]; then
            echo "üöÄ Manual: Run all tests requested"
            TESTS_TO_RUN="all"
            STRATEGY="manual-full"
          elif [ "$EXECUTION_MODE" = "run-specific" ]; then
            SPECIFIC_TESTS="${{ github.event.inputs.specific_tests }}"
            echo "üéØ Manual: Run specific tests - $SPECIFIC_TESTS"
            
            # Filter out login tests - they should only run via authentication setup
            FILTERED_TESTS=$(echo "$SPECIFIC_TESTS" | sed 's/tests-excluded\/login\.spec\.ts//g' | sed 's/login\.spec\.ts//g' | sed 's/  */ /g' | sed 's/^ *//g' | sed 's/ *$//g')
            
            if [ "$FILTERED_TESTS" != "$SPECIFIC_TESTS" ]; then
              echo "üö´ Login tests removed from manual execution - use 'include_login_test' option instead"
            fi
            
            if [ -z "$FILTERED_TESTS" ] || [ "$FILTERED_TESTS" = " " ]; then
              echo "‚ö†Ô∏è No valid tests specified after filtering - defaulting to dashboard test"
              TESTS_TO_RUN="tests/dashboard.spec.ts"
            else
              TESTS_TO_RUN="$FILTERED_TESTS"
            fi
            STRATEGY="manual-specific"
          elif [ "$EXECUTION_MODE" = "change-driven" ]; then
            # Original change-driven logic
            
            # Skip if only documentation changes
            if echo "$CHANGED_FILES" | grep -qE '\.(md|txt|json)$' && ! echo "$CHANGED_FILES" | grep -qvE '\.(md|txt|json)$'; then
              echo "üìù Only documentation changes detected - skipping tests"
              SKIP_TESTS="true"
              STRATEGY="skip"
            else
              echo "üîç Analyzing changed files for test impact..."
              
              # Check for page object changes
              if echo "$CHANGED_FILES" | grep -q "pages/.*\.ts"; then
                CHANGED_PAGES=$(echo "$CHANGED_FILES" | grep "pages/.*\.ts" | sed 's/pages\///g' | sed 's/\.ts//g')
                echo "üìÑ Page objects changed: $CHANGED_PAGES"
                
                for page in $CHANGED_PAGES; do
                  case $page in
                    "login.page"|"base.page")
                      echo "üîê Login page changes detected - authentication setup will be triggered"
                      ;;
                    "dashboard.page")
                      TESTS_TO_RUN="$TESTS_TO_RUN tests/dashboard.spec.ts"
                      ;;
                    "categories.page")
                      TESTS_TO_RUN="$TESTS_TO_RUN tests/categories.spec.ts"
                      ;;
                    "all-posts.page")
                      TESTS_TO_RUN="$TESTS_TO_RUN tests/all-posts.spec.ts"
                      ;;
                    "post.page")
                      TESTS_TO_RUN="$TESTS_TO_RUN tests/post-creation.spec.ts"
                      ;;
                    "page.factory")
                      TESTS_TO_RUN="$TESTS_TO_RUN tests/dashboard.spec.ts tests/categories.spec.ts"
                      ;;
                  esac
                done
              fi
              
              # Check for utility changes
              if echo "$CHANGED_FILES" | grep -q "utils/.*\.ts"; then
                CHANGED_UTILS=$(echo "$CHANGED_FILES" | grep "utils/.*\.ts")
                echo "üîß Utilities changed: $CHANGED_UTILS"
                
                if echo "$CHANGED_UTILS" | grep -q "element.helper\|test.utils\|environment.utils"; then
                  echo "üö® Core utilities changed - running all tests"
                  TESTS_TO_RUN="all"
                  STRATEGY="full"
                elif echo "$CHANGED_UTILS" | grep -q "smart-logger\|error-inspector\|ai-test-healer"; then
                  echo "üß† AI/Logging utilities changed - running smoke tests"
                  TESTS_TO_RUN="tests/dashboard.spec.ts"
                  STRATEGY="smoke"
                fi
              fi
              
              # Check for fixture/data changes
              if echo "$CHANGED_FILES" | grep -q "fixtures/.*\.ts"; then
                echo "üìä Test data changed - running related tests"
                if echo "$CHANGED_FILES" | grep -q "login-data"; then
                  echo "üîê Login data changes detected - authentication setup will be triggered"
                fi
                if echo "$CHANGED_FILES" | grep -q "dashboard-data"; then
                  TESTS_TO_RUN="$TESTS_TO_RUN tests/dashboard.spec.ts"
                fi
              fi
              
              # Check for configuration changes
              if echo "$CHANGED_FILES" | grep -qE "(playwright\.config|tsconfig|package\.json|\.env)"; then
                echo "‚öôÔ∏è Configuration changed - running smoke tests"
                TESTS_TO_RUN="tests/dashboard.spec.ts"
                STRATEGY="config"
              fi
              
              # Check for test file changes
              if echo "$CHANGED_FILES" | grep -q "tests/.*\.spec\.ts"; then
                CHANGED_TESTS=$(echo "$CHANGED_FILES" | grep "tests/.*\.spec\.ts")
                echo "üß™ Test files changed: $CHANGED_TESTS"
                TESTS_TO_RUN="$TESTS_TO_RUN $CHANGED_TESTS"
              fi
              
              # If no specific tests identified, run smoke tests
              if [ -z "$TESTS_TO_RUN" ] && [ "$SKIP_TESTS" = "false" ]; then
                echo "üîç No specific test mapping found - running smoke tests"
                TESTS_TO_RUN="tests/dashboard.spec.ts"
                STRATEGY="smoke"
              fi
            fi
          fi
          
          # Clean up test list
          TESTS_TO_RUN=$(echo "$TESTS_TO_RUN" | tr ' ' '\n' | sort -u | tr '\n' ' ' | sed 's/[[:space:]]*$//')
          
          echo "üéØ Test Strategy: $STRATEGY"
          echo "üß™ Tests to run: $TESTS_TO_RUN"
          echo "‚è≠Ô∏è Skip tests: $SKIP_TESTS"
          
          echo "strategy=$STRATEGY" >> $GITHUB_OUTPUT
          echo "tests=$TESTS_TO_RUN" >> $GITHUB_OUTPUT
          echo "skip=$SKIP_TESTS" >> $GITHUB_OUTPUT

  setup-authentication:
    name: üîê Setup Authentication
    runs-on: ubuntu-latest
    needs: detect-changes
    if: |
      needs.detect-changes.outputs.skip-tests != 'true' && 
      (github.event.inputs.include_login_test == 'true' || 
       contains(needs.detect-changes.outputs.tests-to-run, 'login.spec.ts') ||
       needs.detect-changes.outputs.test-strategy == 'full')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.target_branch || github.ref }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Cache Playwright browsers
        uses: actions/cache@v3
        with:
          path: ~/.cache/ms-playwright
          key: playwright-chromium-${{ hashFiles('package-lock.json') }}

      - name: Install Playwright browsers
        run: npx playwright install chromium --with-deps

      - name: Create temporary Playwright config
        run: |
          cat > playwright.config.temp.ts << 'EOF'
          import { defineConfig, devices } from '@playwright/test';
          import { config } from 'dotenv';
          
          config();
          
          export default defineConfig({
            testDir: './tests-excluded',
            fullyParallel: true,
            forbidOnly: !!process.env.CI,
            retries: process.env.CI ? 2 : 0,
            workers: process.env.CI ? 1 : undefined,
            reporter: 'html',
            use: {
              baseURL: process.env.STAGING_BASE_URL || 'https://staging.go.ione.nyc',
              trace: 'on-first-retry',
              screenshot: 'only-on-failure',
            },
            projects: [
              {
                name: 'chromium',
                use: { ...devices['Desktop Chrome'] },
              },
            ],
          });
          EOF

      - name: Create temporary environment file
        run: |
          cat > .env << 'EOF'
          STAGING_BASE_URL=${{ secrets.STAGING_BASE_URL || 'https://staging.go.ione.nyc' }}
          STAGING_API_URL=${{ secrets.STAGING_API_URL || 'https://staging.go.ione.nyc/wp-json' }}
          STAGING_LOGIN_URL=${{ secrets.STAGING_BASE_URL || 'https://staging.go.ione.nyc' }}/wp-login.php?skip_sso
          ADMIN_USERNAME=${{ secrets.ADMIN_USERNAME }}
          ADMIN_PASSWORD=${{ secrets.ADMIN_PASSWORD }}
          EOF

      - name: üîê Run authentication test
        run: npx playwright test login.spec.ts --config=playwright.config.temp.ts --project=chromium
        env:
          BASE_URL: ${{ secrets.STAGING_BASE_URL || 'https://staging.go.ione.nyc' }}
          API_URL: ${{ secrets.STAGING_API_URL || 'https://staging.go.ione.nyc/wp-json' }}
          LOGIN_URL: ${{ secrets.STAGING_BASE_URL || 'https://staging.go.ione.nyc' }}/wp-login.php

      - name: Clean up temporary files
        if: always()
        run: |
          rm -f playwright.config.temp.ts
          rm -f .env

      - name: Upload authentication state
        uses: actions/upload-artifact@v4
        with:
          name: authentication-state
          path: |
            playwright/.auth/staging-ione.json
            test-results/
          retention-days: 1

      - name: Upload login test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: login-test-results
          path: |
            test-results/
            playwright-report/
          retention-days: 7

  run-targeted-tests:
    name: üß™ Execute Targeted Tests
    runs-on: ubuntu-latest
    needs: [detect-changes, setup-authentication]
    if: needs.detect-changes.outputs.skip-tests != 'true' && (success() || needs.setup-authentication.result == 'skipped')
    strategy:
      matrix:
        browser: [chromium]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Cache Playwright browsers
        uses: actions/cache@v3
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ matrix.browser }}-${{ hashFiles('package-lock.json') }}

      - name: Install Playwright browsers
        run: npx playwright install ${{ matrix.browser }} --with-deps

      - name: Download authentication state
        if: needs.setup-authentication.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: authentication-state
          path: ./

      - name: üè• Verify site accessibility
        run: |
          if curl -f -s "${STAGING_BASE_URL:-https://platform.qa-1.eater.com}/wp-login.php" > /dev/null; then
            echo "‚úÖ Site is accessible"
          else
            echo "‚ùå Site is not accessible"
            exit 1
          fi
        env:
          STAGING_BASE_URL: ${{ secrets.STAGING_BASE_URL }}

      - name: Create temporary Playwright config
        run: |
          # Check if authentication state exists
          if [ -f "playwright/.auth/staging-ione.json" ]; then
            AUTH_STATE="storageState: 'playwright/.auth/staging-ione.json',"
          else
            AUTH_STATE=""
          fi
          
          cat > playwright.config.temp.ts << EOF
          import { defineConfig, devices } from '@playwright/test';
          import { config } from 'dotenv';
          
          config();
          
          export default defineConfig({
            testDir: './tests',
            fullyParallel: true,
            forbidOnly: !!process.env.CI,
            retries: process.env.CI ? 2 : 0,
            workers: process.env.CI ? 1 : undefined,
            reporter: 'html',
            use: {
              baseURL: process.env.STAGING_BASE_URL || 'https://staging.go.ione.nyc',
              trace: 'on-first-retry',
              screenshot: 'only-on-failure',
              ${AUTH_STATE}
            },
            projects: [
              {
                name: 'chromium',
                use: { ...devices['Desktop Chrome'] },
              },
            ],
          });
          EOF

      - name: Create temporary environment file
        run: |
          cat > .env << 'EOF'
          STAGING_BASE_URL=${{ secrets.STAGING_BASE_URL || 'https://staging.go.ione.nyc' }}
          STAGING_API_URL=${{ secrets.STAGING_API_URL || 'https://staging.go.ione.nyc/wp-json' }}
          STAGING_LOGIN_URL=${{ secrets.STAGING_BASE_URL || 'https://staging.go.ione.nyc' }}/wp-login.php?skip_sso
          ADMIN_USERNAME=${{ secrets.ADMIN_USERNAME }}
          ADMIN_PASSWORD=${{ secrets.ADMIN_PASSWORD }}
          EOF

      - name: üéØ Run Targeted Tests
        run: |
          STRATEGY="${{ needs.detect-changes.outputs.test-strategy }}"
          TESTS="${{ needs.detect-changes.outputs.tests-to-run }}"
          
          echo "üìã Execution Plan:"
          echo "Strategy: $STRATEGY"
          echo "Tests: $TESTS"
          echo ""
          
          if [ "$TESTS" = "all" ]; then
            echo "üöÄ Running full test suite"
            npx playwright test --config=playwright.config.temp.ts --project=${{ matrix.browser }}
          else
            echo "üéØ Running targeted tests: $TESTS"
            npx playwright test $TESTS --config=playwright.config.temp.ts --project=${{ matrix.browser }}
          fi
        env:
          BASE_URL: ${{ secrets.STAGING_BASE_URL || 'https://platform.qa-1.eater.com' }}
          API_URL: ${{ secrets.STAGING_API_URL || 'https://platform.qa-1.eater.com/wp-json' }}
          LOGIN_URL: ${{ secrets.STAGING_BASE_URL || 'https://platform.qa-1.eater.com' }}/wp-login.php

      - name: Clean up temporary files
        if: always()
        run: |
          rm -f playwright.config.temp.ts
          rm -f .env

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.browser }}-${{ needs.detect-changes.outputs.test-strategy }}
          path: |
            test-results/
            playwright-report/
          retention-days: 7

  cross-browser-validation:
    name: üåê Cross-Browser Validation
    runs-on: ubuntu-latest
    needs: [detect-changes, setup-authentication, run-targeted-tests]
    if: (needs.detect-changes.outputs.test-strategy == 'full' || needs.detect-changes.outputs.test-strategy == 'manual-full' || github.event.inputs.browser_matrix == 'cross-browser') && needs.detect-changes.outputs.skip-tests != 'true'
    strategy:
      matrix:
        browser: [firefox, webkit]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Cache Playwright browsers
        uses: actions/cache@v3
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ matrix.browser }}-${{ hashFiles('package-lock.json') }}

      - name: Install Playwright browsers
        run: npx playwright install ${{ matrix.browser }} --with-deps

      - name: Download authentication state
        if: needs.setup-authentication.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: authentication-state
          path: ./

      - name: Create temporary Playwright config
        run: |
          # Check if authentication state exists
          if [ -f "playwright/.auth/staging-ione.json" ]; then
            AUTH_STATE="storageState: 'playwright/.auth/staging-ione.json',"
          else
            AUTH_STATE=""
          fi
          
          cat > playwright.config.temp.ts << EOF
          import { defineConfig, devices } from '@playwright/test';
          import { config } from 'dotenv';
          
          config();
          
          export default defineConfig({
            testDir: './tests',
            fullyParallel: true,
            forbidOnly: !!process.env.CI,
            retries: process.env.CI ? 2 : 0,
            workers: process.env.CI ? 1 : undefined,
            reporter: 'html',
            use: {
              baseURL: process.env.STAGING_BASE_URL || 'https://staging.go.ione.nyc',
              trace: 'on-first-retry',
              screenshot: 'only-on-failure',
              ${AUTH_STATE}
            },
            projects: [
              {
                name: 'firefox',
                use: { ...devices['Desktop Firefox'] },
              },
              {
                name: 'webkit',
                use: { ...devices['Desktop Safari'] },
              },
            ],
          });
          EOF

      - name: Create temporary environment file
        run: |
          cat > .env << 'EOF'
          STAGING_BASE_URL=${{ secrets.STAGING_BASE_URL || 'https://staging.go.ione.nyc' }}
          STAGING_API_URL=${{ secrets.STAGING_API_URL || 'https://staging.go.ione.nyc/wp-json' }}
          STAGING_LOGIN_URL=${{ secrets.STAGING_BASE_URL || 'https://staging.go.ione.nyc' }}/wp-login.php?skip_sso
          ADMIN_USERNAME=${{ secrets.ADMIN_USERNAME }}
          ADMIN_PASSWORD=${{ secrets.ADMIN_PASSWORD }}
          EOF

      - name: üåê Run Cross-Browser Tests
        run: |
          TESTS="${{ needs.detect-changes.outputs.tests-to-run }}"
          if [ "$TESTS" = "all" ]; then
            npx playwright test --config=playwright.config.temp.ts --project=${{ matrix.browser }}
          else
            npx playwright test $TESTS --config=playwright.config.temp.ts --project=${{ matrix.browser }}
          fi
        env:
          BASE_URL: ${{ secrets.STAGING_BASE_URL || 'https://platform.qa-1.eater.com' }}
          API_URL: ${{ secrets.STAGING_API_URL || 'https://platform.qa-1.eater.com/wp-json' }}
          LOGIN_URL: ${{ secrets.STAGING_BASE_URL || 'https://platform.qa-1.eater.com' }}/wp-login.php

      - name: Clean up temporary files
        if: always()
        run: |
          rm -f playwright.config.temp.ts
          rm -f .env

      - name: Upload cross-browser results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cross-browser-results-${{ matrix.browser }}
          path: |
            test-results/
            playwright-report/
          retention-days: 7

  generate-report:
    name: üìä Generate Test Report
    runs-on: ubuntu-latest
    needs: [detect-changes, setup-authentication, run-targeted-tests]
    if: always() && needs.detect-changes.outputs.skip-tests != 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Generate consolidated report
        run: |
          echo "# üß™ Test Execution Report" > test-summary.md
          echo "" >> test-summary.md
          echo "**Strategy**: ${{ needs.detect-changes.outputs.test-strategy }}" >> test-summary.md
          echo "**Tests Executed**: ${{ needs.detect-changes.outputs.tests-to-run }}" >> test-summary.md
          echo "" >> test-summary.md
          
          # Count test results
          PASSED=$(find artifacts/ -name "*.xml" -exec grep -l 'failures="0"' {} \; 2>/dev/null | wc -l || echo "0")
          FAILED=$(find artifacts/ -name "*.xml" -exec grep -l 'failures="[1-9]"' {} \; 2>/dev/null | wc -l || echo "0")
          
          echo "## üìà Results Summary" >> test-summary.md
          echo "- ‚úÖ Passed: $PASSED" >> test-summary.md
          echo "- ‚ùå Failed: $FAILED" >> test-summary.md
          echo "" >> test-summary.md
          
          if [ "${{ needs.detect-changes.outputs.test-strategy }}" != "full" ]; then
            echo "## üéØ Optimization Impact" >> test-summary.md
            echo "Targeted testing saved time by running only relevant tests based on file changes." >> test-summary.md
            echo "" >> test-summary.md
          fi

      - name: Upload consolidated report
        uses: actions/upload-artifact@v4
        with:
          name: test-summary-report
          path: test-summary.md

  notify:
    name: üì¢ Notify Results
    runs-on: ubuntu-latest
    needs: [detect-changes, setup-authentication, run-targeted-tests]
    if: always()
    steps:
      - name: üìã Post GitHub Summary
        run: |
          if [ "${{ needs.detect-changes.outputs.skip-tests }}" = "true" ]; then
            echo "## üìù Tests Skipped" >> $GITHUB_STEP_SUMMARY
            echo "Only documentation files were changed - no tests executed." >> $GITHUB_STEP_SUMMARY
          else
            echo "## üß™ Test Execution Summary" >> $GITHUB_STEP_SUMMARY
            echo "**Mode**: ${{ github.event.inputs.execution_mode || 'change-driven' }}" >> $GITHUB_STEP_SUMMARY
            echo "**Strategy**: ${{ needs.detect-changes.outputs.test-strategy }}" >> $GITHUB_STEP_SUMMARY
            echo "**Tests**: ${{ needs.detect-changes.outputs.tests-to-run }}" >> $GITHUB_STEP_SUMMARY
            echo "**Browser Matrix**: ${{ github.event.inputs.browser_matrix || 'chromium-only' }}" >> $GITHUB_STEP_SUMMARY
            echo "**Authentication**: ${{ needs.setup-authentication.result != 'skipped' && '‚úÖ Enabled' || '‚è≠Ô∏è Skipped' }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            if [ "${{ needs.run-targeted-tests.result }}" = "success" ]; then
              echo "‚úÖ **All targeted tests passed!**" >> $GITHUB_STEP_SUMMARY
            else
              echo "‚ùå **Some tests failed - check artifacts for details**" >> $GITHUB_STEP_SUMMARY
            fi
            
            # Add authentication specific notes
            if [ "${{ needs.setup-authentication.result }}" = "success" ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "üîê **Authentication**: Login test passed - session state available for E2E tests" >> $GITHUB_STEP_SUMMARY
            elif [ "${{ needs.setup-authentication.result }}" = "failure" ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "üö® **Authentication**: Login test failed - check authentication artifacts" >> $GITHUB_STEP_SUMMARY
            fi
            
            # Add execution mode specific notes
            case "${{ github.event.inputs.execution_mode }}" in
              "run-all")
                echo "" >> $GITHUB_STEP_SUMMARY
                echo "üöÄ **Manual execution**: Full test suite requested" >> $GITHUB_STEP_SUMMARY
                ;;
              "run-specific")
                echo "" >> $GITHUB_STEP_SUMMARY
                echo "üéØ **Manual execution**: Specific tests - ${{ github.event.inputs.specific_tests }}" >> $GITHUB_STEP_SUMMARY
                ;;
              "change-driven"|"")
                if [ "${{ needs.detect-changes.outputs.test-strategy }}" != "skip" ]; then
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "üß† **Smart execution**: Tests selected based on file changes" >> $GITHUB_STEP_SUMMARY
                fi
                ;;
            esac
          fi